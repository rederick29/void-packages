# Template file for 'rccl'
pkgname=rccl
version=6.1.0
revision=1
archs="x86_64"
build_style=cmake
configure_args="-Wno-dev -DCMAKE_CXX_COMPILER=/opt/rocm/bin/hipcc -DCMAKE_C_COMPILER=/opt/rocm/bin/hipcc -DCMAKE_INSTALL_PREFIX=/opt/rocm -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON -DCMAKE_INSTALL_LIBDIR=lib"
hostmakedepends="hipamd HIPIFY perl"
makedepends="rocm-cmake ROCm-Device-Libs rocm_smi_lib"
depends="ROCm-core"
short_desc="ROCm Communication Collectives Library"
maintainer="Erick Vilcica <erick.vilcica@protonmail.com>"
license="custom:Proprietary"
homepage="https://github.com/ROCmSoftwarePlatform/rccl"
changelog="https://github.com/ROCmSoftwarePlatform/rccl/raw/develop/CHANGELOG.md"
distfiles="https://github.com/ROCmSoftwarePlatform/rccl/archive/rocm-${version}.tar.gz"
checksum=c6308f6883cbd63dceadbe4ee154cc6fa9e6bdccbd2f0fda295b564b0cf01e9a
LDFLAGS=-L/opt/rocm/lib64

# GPU architectures to build for
build_options="gfx803 gfx900 gfx906 gfx908 gfx90a gfx940 gfx941 gfx942 gfx1010 gfx1011 gfx1012 gfx1030 gfx1031 gfx1100 gfx1101 gfx1102"

build_options_default="gfx803 gfx900 gfx906 gfx908 gfx90a gfx940 gfx941 gfx942 gfx1010 gfx1011 gfx1012 gfx1030 gfx1031 gfx1100 gfx1101 gfx1102"

pre_configure() {
    # remove their default targets list, somehow
    gpu_targets="$(vopt_if gfx803 'gfx803 ')$(vopt_if gfx900 'gfx900 ')$(vopt_if gfx906 'gfx906 ')$(vopt_if gfx908 'gfx908 ')$(vopt_if gfx90a 'gfx90a ')$(vopt_if gfx940 'gfx940;')$(vopt_if gfx941 'gfx941;')$(vopt_if gfx942 'gfx942;')$(vopt_if gfx1010 'gfx1010 ')$(vopt_if gfx1011 'gfx1011 ')$(vopt_if gfx1012 'gfx1012 ')$(vopt_if gfx1030 'gfx1030 ')$(vopt_if gfx1031 'gfx1031 ')$(vopt_if gfx1100 'gfx1100 ')$(vopt_if gfx1101 'gfx1101 ')$(vopt_if gfx1102 'gfx1102 ')"

    perl -i -p0e "s/\s+gfx803\s+gfx900:xnack-\s+gfx906:xnack-\s+gfx908:xnack-\s+gfx90a:xnack-\s+gfx90a:xnack\+\s+gfx940\s+gfx941\s+gfx942\s+gfx1030\s+gfx1100\s+gfx1101\s+gfx1102/ ${gpu_targets}/gm" CMakeLists.txt
}

post_install() {
	vlicense LICENSE.txt
}
