# Template file for 'hipFFT'
pkgname=hipFFT
version=6.0.2
# separate versions
_hipfft_version=6.0.2
_rocfft_version=6.0.2
revision=1
archs="x86_64"
build_style=cmake
configure_args="-S ../${pkgname}-rocm-${_hipfft_version} -B . -DCMAKE_CXX_COMPILER=/opt/rocm/bin/hipcc -DHIP_ROOT_DIR=/opt/rocm/hip -DCMAKE_INSTALL_PREFIX=/opt/rocm -DCMAKE_INSTALL_LIBDIR=lib"
hostmakedepends="rocm-llvm hipamd git"
makedepends="rocm-cmake ROCm-Device-Libs rocFFT"
depends="ROCm-core"
short_desc="ROCm FFT marshalling library"
maintainer="Erick Vilcica <erick.vilcica@protonmail.com>"
license="MIT"
homepage="https://github.com/ROCmSoftwarePlatform/hipFFT"
changelog="https://github.com/ROCmSoftwarePlatform/hipFFT/raw/develop/CHANGELOG.md"
distfiles="https://github.com/ROCmSoftwarePlatform/hipFFT/archive/rocm-${version}.tar.gz>hipfft.tar.gz
https://github.com/ROCmSoftwarePlatform/rocFFT/archive/rocm-${version}.tar.gz"
checksum="c0a4bac5fa9a757a19a4995fa9571328b6ee0a71e93c66a880069794d65d284a
 d3e1f7a4dc661f1e5ffce02e2e01ae6c3c339bac8e93deaf175e4c03ddfea459"

build_options="gfx803 gfx900 gfx906 gfx908 gfx90a gfx940 gfx941 gfx942 gfx1010 gfx1011 gfx1012 gfx1030 gfx1031 gfx1100 gfx1101 gfx1102"

build_options_default="gfx803 gfx900 gfx906 gfx908 gfx90a gfx940 gfx941 gfx942 gfx1010 gfx1011 gfx1012 gfx1030 gfx1031 gfx1100 gfx1101 gfx1102"

pre_configure() {
    # rocFFT source needs to be available in clients/rocFFT
    # || rm in case of dirty build
    rmdir hipFFT-rocm-${_hipfft_version}/clients/rocFFT 2> /dev/null || rm hipFFT-rocm-${_hipfft_version}/clients/rocFFT 2> /dev/null
    ln -s $(readlink -f rocFFT-rocm-${_rocfft_version}) hipFFT-rocm-${_hipfft_version}/clients/rocFFT

    # note: I doubt that it matters for this package but fwiw,
    # respect compile targets
    sed -i "s/gfx803;gfx900;gfx906;gfx908;gfx90a;gfx940;gfx941;gfx942;gfx1030;gfx1100;gfx1101;gfx1102/$(vopt_if gfx803 'gfx803;')$(vopt_if gfx900 'gfx900;')$(vopt_if gfx906 'gfx906;')$(vopt_if gfx908 'gfx908;')$(vopt_if gfx90a 'gfx90a;')$(vopt_if gfx940 'gfx940;')$(vopt_if gfx941 'gfx941;')$(vopt_if gfx942 'gfx942;')$(vopt_if gfx1010 'gfx1010;')$(vopt_if gfx1011 'gfx1011;')$(vopt_if gfx1012 'gfx1012;')$(vopt_if gfx1030 'gfx1030;')$(vopt_if gfx1031 'gfx1031;')$(vopt_if gfx1100 'gfx1100;')$(vopt_if gfx1101 'gfx1101;')$(vopt_if gfx1102 'gfx1102;')/g" hipFFT-rocm-${_hipfft_version}/CMakeLists.txt
}

post_install() {
	vlicense hipFFT-rocm-${_hipfft_version}/LICENSE.md
}
