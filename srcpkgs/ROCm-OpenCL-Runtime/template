# Template file for 'ROCm-OpenCL-Runtime'
pkgname=ROCm-OpenCL-Runtime
version=5.5.0
revision=1
archs="x86_64"
build_style=cmake
makedepends="ROCm-CompilerSupport ROCR-Runtime libnuma libnuma-devel rocm-cmake libglvnd-devel ROCm-core libclc opencl2-headers ocl-icd ocl-icd-devel"
depends="ROCm-core"
short_desc="OpenCL runtime for ROCm"
maintainer="Erick Vilcica <erick.vilcica@protonmail.com>"
license="MIT"
homepage="https://github.com/RadeonOpenCompute/ROCm-OpenCL-Runtime"
distfiles="https://github.com/RadeonOpenCompute/ROCm-OpenCL-Runtime/archive/rocm-${version}.tar.gz>rocm-opencl.tar.gz
https://github.com/ROCm-Developer-Tools/ROCclr/archive/rocm-${version}.tar.gz>rocclr.tar.gz"
checksum="0df9fa0b8aa0c8e6711d34eec0fdf1ed356adcd9625bc8f1ce9b3e72090f3e4f
efbae9a1ef2ab3de5ca44091e9bb78522e76759c43524c1349114f9596cc61d1"

do_configure() {
	_ROCclr_DIR="${wrksrc}/ROCclr-rocm-${version}"
	_OPENCL_DIR="${wrksrc}/ROCm-OpenCL-Runtime-rocm-${version}"

	cd ${_ROCclr_DIR}
	mkdir -p build; cd build
	cmake -G Ninja -Wno-dev -DAMD_OPENCL_PATH="${_OPENCL_DIR}" -DOPENCL_DIR=${_OPENCL_DIR} -DCMAKE_INSTALL_PREFIX=/opt/rocm/rocclr -DCMAKE_BUILD_TYPE=Release ..

	cd ${wrksrc}
	mkdir -p build; cd build
	cmake -G Ninja -S ${_OPENCL_DIR} -DBUILD_ICD=OFF -DCMAKE_INSTALL_PREFIX=/opt/rocm -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${_ROCclr_DIR};/opt/rocm" -DAMD_OPENCL_PATH="${_OPENCL_DIR}"
}

do_build() {
	_ROCclr_DIR="${wrksrc}/ROCclr-rocm-${version}"
	_OPENCL_DIR="${wrksrc}/ROCm-OpenCL-Runtime-rocm-${version}"

	cmake --build ${_ROCclr_DIR}/build --config Release -j ${XBPS_MAKEJOBS}
	cmake --build build --config Release -j ${XBPS_MAKEJOBS}
}

post_install() {
	vmkdir etc/OpenCL/vendors
	# use full path as its installed to /opt
	echo "/opt/rocm/lib/libamdocl64.so" > ${DESTDIR}/etc/OpenCL/vendors/amdocl64.icd
	cd ${wrksrc}/ROCm-OpenCL-Runtime-rocm-${version}
	vlicense LICENSE.txt
}

ROCclr_package() {
	short_desc="ROCm Common Language Runtime"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		cd ${wrksrc}/ROCclr-rocm-${version}/build
		vmkdir opt/rocm/rocclr
		vmkdir opt/rocm/lib
		vcopy librocclr.a opt/rocm/rocclr
		ln -sfr ${PKGDESTDIR}/opt/rocm/rocclr/librocclr.a ${PKGDESTDIR}/opt/rocm/lib
		cd ..
		vlicense LICENSE.txt
	}
}
